<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ªå•è¨ºç™‚ä½“åˆ¶ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        :root {
            --color-base: #FFFFFF;
            --color-surface: #F8FAF9;
            --color-main: #2D5A27;
            --color-sub: #4CAF50;
            --color-text: #333333;
            --color-text-light: #666666;
            --color-border: #E0E0E0;
            --color-hover: #E8F5E9;
            --border-radius: 8px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }

        body {
            background-color: var(--color-surface);
            color: var(--color-text);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--color-main);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 0.5rem 1rem;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 1.5rem;
            gap: 1.5rem;
        }

        /* Left Column */
        .left-col {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: var(--color-base);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .clinic-tabs {
            display: flex;
            background: #f1f1f1;
            border-bottom: 1px solid var(--color-border);
        }

        .clinic-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: transparent;
            border-radius: 0;
            color: var(--color-text-light);
            font-weight: bold;
            font-size: 1rem;
        }

        .clinic-tab.active {
            background: var(--color-base);
            color: var(--color-main);
            border-bottom: 3px solid var(--color-main);
        }

        .date-tabs {
            display: flex;
            overflow-x: auto;
            border-bottom: 1px solid var(--color-border);
            padding: 0.5rem 1rem 0;
        }

        .date-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            margin-right: 0.5rem;
            color: var(--color-text-light);
            white-space: nowrap;
        }

        .date-tab.active {
            background: var(--color-main);
            color: white;
        }

        .routes-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .route-row {
            display: grid;
            grid-template-columns: 50px minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(150px, 2fr);
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed var(--color-border);
        }

        .route-row:last-child {
            border-bottom: none;
        }

        .route-label {
            font-weight: bold;
            color: var(--color-text-light);
            text-align: center;
        }

        .field-label {
            font-size: 0.8rem;
            color: var(--color-text-light);
            margin-bottom: 0.2rem;
            display: block;
        }

        /* Card Selector styles */
        .card-select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.6rem;
            text-align: left;
            width: 100%;
            height: 42px;
            color: var(--color-text);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-select:hover {
            border-color: var(--color-main);
            background: var(--color-hover);
        }

        .card-select.has-value {
            border-color: var(--color-main);
            font-weight: bold;
            color: var(--color-main);
            background: rgba(45, 90, 39, 0.05);
        }

        .card-select::after {
            content: 'â–¼';
            font-size: 0.7rem;
            color: var(--color-text-light);
        }

        input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.9rem;
            height: 42px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-main);
            box-shadow: 0 0 0 2px rgba(45, 90, 39, 0.2);
        }

        .general-remarks {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }

        /* Right Column */
        .right-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--color-base);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .preview-header {
            padding: 1rem 1.5rem;
            background: #f1f1f1;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h2 {
            font-size: 1.1rem;
            color: var(--color-text);
        }

        .preview-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--color-sub);
            color: white;
            padding: 0.6rem 1.2rem;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #43A047;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-main);
            color: white;
            padding: 0.6rem 1.2rem;
            font-weight: bold;
        }

        .btn-secondary:hover {
            background: #1A4D2E;
        }

        .preview-content {
            flex: 1;
            padding: 1.5rem;
        }

        textarea {
            width: 100%;
            height: 100%;
            resize: none;
            padding: 1rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            line-height: 1.6;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--color-main);
        }

        /* Selection Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-base);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            color: var(--color-main);
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-light);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }

        .select-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.8rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            color: var(--color-text);
        }

        .select-card:hover {
            border-color: var(--color-main);
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .select-card.selected {
            background: var(--color-main);
            color: white;
            border-color: var(--color-main);
            font-weight: bold;
        }

        .select-card.empty-card {
            border-style: dashed;
            color: var(--color-text-light);
            background: transparent;
        }

        .select-card.empty-card:hover {
            border-color: #f44336;
            color: #f44336;
            background: #ffebee;
        }

        /* Master Editor Modal */
        .master-modal-body {
            display: flex;
            height: 50vh;
        }

        .master-sidebar {
            width: 150px;
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
        }

        .master-tab {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
            text-align: left;
            background: transparent;
            border-left: 3px solid transparent;
        }

        .master-tab.active {
            background: var(--color-base);
            font-weight: bold;
            color: var(--color-main);
            border-left: 3px solid var(--color-main);
        }

        .master-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .master-clinic-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-btn {
            padding: 0.3rem 0.8rem;
            font-size: 0.85rem;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background: var(--color-base);
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--color-main);
            color: white;
            border-color: var(--color-main);
        }

        .master-item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .master-item {
            background: #f1f1f1;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .master-item-del {
            cursor: pointer;
            color: red;
            font-weight: bold;
        }

        .add-item-form {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .add-item-form input {
            height: 36px;
        }

        .btn-add {
            background: var(--color-sub);
            color: white;
            border: none;
            padding: 0 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <header>
        <h1>è¨ªå•è¨ºç™‚ä½“åˆ¶ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <div class="header-controls">
            <button class="btn-outline" id="btnExport">ğŸ“¥ JSONå‡ºåŠ›</button>
            <button class="btn-outline" id="btnImport">ğŸ“¤ èª­è¾¼</button>
            <button class="btn-outline" id="btnMaster">âš™ï¸ ãƒã‚¹ã‚¿ç·¨é›†</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Column: Input Panel -->
        <div class="left-col">
            <div class="clinic-tabs" id="clinicTabs">
                <button class="clinic-tab active" data-clinic="é«˜ç”°é¦¬å ´">é«˜ç”°é¦¬å ´</button>
                <button class="clinic-tab" data-clinic="æ¸‹è°·">æ¸‹è°·</button>
                <button class="clinic-tab" data-clinic="ä¸‰é·¹">ä¸‰é·¹</button>
            </div>

            <div class="date-tabs" id="dateTabs">
                <!-- Dynamically generated -->
            </div>

            <div class="routes-container" id="routesContainer">
                <div class="route-header"
                    style="display: grid; grid-template-columns: 50px minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(150px, 2fr); gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--color-text-light); text-align: left;">
                    <span style="text-align: center;">ãƒ«ãƒ¼ãƒˆ</span>
                    <span>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ (å¿…é ˆ)</span>
                    <span>Dr(AM) (å¿…é ˆ)</span>
                    <span>Dr(PM)</span>
                    <span>CD</span>
                    <span>Ns</span>
                    <span>å‚™è€ƒ</span>
                </div>
                <!-- Route rows will be dynamically generated by JS -->
                <div id="routeRows"></div>

                <div class="general-remarks">
                    <label class="field-label">å…¨ä½“å‚™è€ƒ</label>
                    <input type="text" id="generalRemarks" placeholder="ä¾‹: ä»¥ä¸Šã€ã‚ˆã‚ã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚">
                </div>
            </div>
        </div>

        <!-- Right Column: Preview / Output -->
        <div class="right-col">
            <div class="preview-header">
                <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <div class="preview-actions">
                    <button class="btn-secondary" id="btnGenerateAll">å…¨æ—¥åˆ†ç”Ÿæˆ</button>
                    <button class="btn-primary" id="btnCopy">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
            <div class="preview-content">
                <textarea id="outputArea" readonly placeholder="ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
            </div>
        </div>
    </div>

    <!-- Selection Modal (For Cards) -->
    <div class="modal-overlay" id="selectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="selectionModalTitle">é¸æŠã—ã¦ãã ã•ã„</h3>
                <button class="close-btn" id="closeSelectionModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="card-grid" id="selectionGrid">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Master Editor Modal -->
    <div class="modal-overlay" id="masterModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ãƒã‚¹ã‚¿ç·¨é›†</h3>
                <div>
                    <button class="btn-outline" style="border-color: var(--color-border); color: var(--color-text);"
                        id="btnResetMaster">ğŸ”„ åˆæœŸå€¤ã«æˆ»ã™</button>
                    <button class="close-btn" id="closeMasterModal">Ã—</button>
                </div>
            </div>
            <div class="master-modal-body">
                <div class="master-sidebar" id="masterSidebar">
                    <button class="master-tab active" data-type="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</button>
                    <button class="master-tab" data-type="dr">Dr</button>
                    <button class="master-tab" data-type="cd">CD</button>
                    <button class="master-tab" data-type="ns">Ns</button>
                </div>
                <div class="master-content">
                    <div class="master-clinic-filter" id="masterClinicFilter">
                        <button class="filter-btn active" data-clinic="é«˜ç”°é¦¬å ´">é«˜ç”°é¦¬å ´</button>
                        <button class="filter-btn" data-clinic="æ¸‹è°·">æ¸‹è°·</button>
                        <button class="filter-btn" data-clinic="ä¸‰é·¹">ä¸‰é·¹</button>
                        <button class="filter-btn" data-clinic="å…±é€š" id="filterCommon" style="display:none;">å…±é€š</button>
                    </div>
                    <div class="master-item-list" id="masterItemList">
                        <!-- Items rendered here -->
                    </div>
                    <div class="add-item-form">
                        <input type="text" id="newMasterItemName" placeholder="æ–°ã—ã„åå‰ã‚’è¿½åŠ ...">
                        <button class="btn-add" id="btnAddNewItem">è¿½åŠ </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Master Data Definitions ---
        const DEFAULT_MASTER = {
            driver: {
                'é«˜ç”°é¦¬å ´': ['å²©æ°¸', 'ç‰‡å²¡', 'é«˜æ©‹', 'å®®å…ƒ', 'ç¥å°¾'],
                'æ¸‹è°·': ['åŒ—å·', 'èµ¤åŸ', 'å²¡å¯º'],
                'ä¸‰é·¹': ['ä¸­é“', 'æ¸¡éƒ¨', 'è°·å£']
            },
            dr: {
                'é«˜ç”°é¦¬å ´': ['äº”ååµ', 'æ—', 'å·¥è—¤', 'å€™', 'çœé‹', 'é–“æ·µ', 'é£¯ç”°', 'ç¬¹å³¶', 'ç™¾æ‘', 'æ–¹', 'çŸ¢ç´', 'è…é‡å„ª', 'é è—¤', 'å‰æœ¬', 'èŠæ± ', 'åœŸè‚¥', 'ç™ºç”°', 'æ·±æ²¢', 'è°·', 'è¥¿æ¾¤', 'æ²³é‡', 'ç´€å·', 'åœ‹åˆ†', 'å°æ¾¤', 'ç«¹å†…', 'å‰ç”°', 'è…é‡ç¾©', 'åˆ‡å£«', 'å·¥è—¤ä¸‡é‡Œ', 'èŠ¹æ¾¤', 'å°æœ¨æ›½', 'å†…è—¤', 'å®‡é‡', 'å²¡å±±', 'å²©èŠ±', 'æ˜Ÿ'],
                'æ¸‹è°·': ['å¤§è°·', 'å®®å²¡', 'å®®å·', 'æ¸¡ç€¬', 'è¥¿éƒ·', 'äº•å‡º', 'å±±å£', 'é«™è°·', 'é«™æ©‹', 'å‡ºé›²', 'æ¡‘åŸ', 'æ³Š', 'è‚¥å¾Œ', 'å‰ï¨‘', 'è°·é‡', 'å¯Œç”°'],
                'ä¸‰é·¹': ['æ¡‘åŸ', 'å°å±±', 'ç«¹å†…', 'ä¸‰æµ¦', 'ç¥æ—', 'æ²³åˆ', 'åˆç”°', 'æ‰å®‰', 'ä¼Šè—¤', 'æ¸¡é‚‰', 'è±ª', 'å³¶æ´¥']
            },
            cd: {
                'å…±é€š': ['å¸‚å·', 'å°æœ¨', 'åº„ç”°', 'æ¿µæœ¬', 'åŠ è—¤', 'çŸ³å·', 'è—¤å²¡', 'æ¸¡é‚‰', 'ç• å±±', 'å‰ç”°', 'å±±å£', 'æ¾å°¾', 'å…«é‡å¶½', 'é«˜ç”°', 'å°é‡', 'å®‰ç”°', 'é«™ç”°', 'æ²³é‡', 'ç‰‡åˆ', 'é•·è°·å·', 'ä¼Šè—¤', 'ç”°ä¸­', 'æ ¢åŸ', 'ç£¯è¾º', 'ä¸‰æ¾¤', 'ç§‹å±±', 'æ²³åˆ', 'ç†Šè°·', 'ç±³ç”°', 'å†…ç”°']
            },
            ns: {
                'é«˜ç”°é¦¬å ´': ['å¤æ¾¤', 'å¹³é‡', 'é•·è°·å·', 'ç‰ç”°', 'è¥¿ç”°', 'æ²³è¥¿', 'æ¸¡éƒ¨', 'ä¼Šæ±', 'å¢—ç”°', 'ä½è—¤', 'å¥¥æ‘', 'æ©‹', 'ä¸­å±±', 'å°æ—', 'å®¤æ©‹'],
                'æ¸‹è°·': ['ç”°åŸ', 'ä»²çœ', 'èµ¤å°¾', 'ä½ã€…æœ¨', 'ä»Šäº•', 'å°åŸ', 'é½‹è—¤', 'å²¡å´', 'æœ¨å†…'],
                'ä¸‰é·¹': ['çŸ³å‚', 'æ¸…æ°´', 'ä¸­æ‘', 'æ¨ªå±±', 'æ¨ªå°¾', 'å®®é‡']
            }
        };

        const STORAGE_KEY_MASTER = 'vcare_gen_master';
        const STORAGE_KEY_SCHEDULE = 'vcare_gen_schedule';
        const DAYS_COUNT = 7;
        const ROUTES_PER_DAY = 6;

        // --- 2. State Management ---
        let masterData = null;
        let scheduleData = {}; // Format: { "YYYY-MM-DD": { "clinic": { routes: [], generalRemarks: "" } } }
        let currentClinic = 'é«˜ç”°é¦¬å ´';
        let currentDateStr = ''; // Used as key for scheduleData
        let datesArray = []; // Array of { dateKey: 'YYYY-MM-DD', displayStr: 'MM/DD(Day)' }

        // --- 3. Initialization ---
        function initApp() {
            // Load Master Data
            const storedMaster = localStorage.getItem(STORAGE_KEY_MASTER);
            if (storedMaster) {
                try { masterData = JSON.parse(storedMaster); } catch (e) { masterData = JSON.parse(JSON.stringify(DEFAULT_MASTER)); }
            } else {
                masterData = JSON.parse(JSON.stringify(DEFAULT_MASTER));
            }

            // Generate Dates array (Today to Today+6)
            const today = new Date();
            const daysOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let i = 0; i < DAYS_COUNT; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const dateKey = `${yyyy}-${mm}-${dd}`;
                const displayStr = `${d.getMonth() + 1}/${d.getDate()}(${daysOfWeek[d.getDay()]})`;
                datesArray.push({ dateKey, displayStr });
            }
            currentDateStr = datesArray[0].dateKey;

            // Load Schedule Data
            const storedSchedule = localStorage.getItem(STORAGE_KEY_SCHEDULE);
            if (storedSchedule) {
                try { scheduleData = JSON.parse(storedSchedule); } catch (e) { /* ignore */ }
            }

            // Render Layout UI
            renderDateTabs();
            renderRoutes();
            setupEventListeners();
        }

        // --- 4. Utilities ---
        function getEmptyRoute() {
            return { driver: '', dr_am: '', dr_pm: '', cd: '', ns: '', remark: '' };
        }

        function ensureScheduleStructure(dateKey, clinic) {
            if (!scheduleData[dateKey]) {
                scheduleData[dateKey] = {};
            }
            if (!scheduleData[dateKey][clinic]) {
                scheduleData[dateKey][clinic] = { routes: [], generalRemarks: '' };
                for (let i = 0; i < ROUTES_PER_DAY; i++) {
                    scheduleData[dateKey][clinic].routes.push(getEmptyRoute());
                }
            }
        }

        function saveSchedule() {
            localStorage.setItem(STORAGE_KEY_SCHEDULE, JSON.stringify(scheduleData));
            updateOutputText();
        }

        // --- 5. Render UI ---
        function renderDateTabs() {
            const tabsContainer = document.getElementById('dateTabs');
            tabsContainer.innerHTML = '';
            datesArray.forEach(d => {
                const btn = document.createElement('button');
                btn.className = `date-tab ${d.dateKey === currentDateStr ? 'active' : ''}`;
                btn.textContent = d.displayStr;
                btn.addEventListener('click', () => {
                    currentDateStr = d.dateKey;
                    renderDateTabs();
                    renderRoutes();
                });
                tabsContainer.appendChild(btn);
            });
        }

        function renderRoutes() {
            ensureScheduleStructure(currentDateStr, currentClinic);
            const container = document.getElementById('routeRows');
            container.innerHTML = '';
            const dayData = scheduleData[currentDateStr][currentClinic];

            dayData.routes.forEach((route, index) => {
                const row = document.createElement('div');
                row.className = 'route-row';

                row.innerHTML = `<div class="route-label">${index + 1}</div>`;

                // Fields
                const fields = [
                    { type: 'driver', title: 'Driver' },
                    { type: 'dr_am', title: 'Dr(AM)' },
                    { type: 'dr_pm', title: 'Dr(PM)' },
                    { type: 'cd', title: 'CD' },
                    { type: 'ns', title: 'Ns' }
                ];

                fields.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = `card-select ${route[f.type] ? 'has-value' : ''}`;
                    btn.textContent = route[f.type] || 'é¸æŠ...';
                    btn.addEventListener('click', () => openSelectionModal(index, f.type, f.title));
                    row.appendChild(btn);
                });

                // Remark Input
                const remarkInput = document.createElement('input');
                remarkInput.type = 'text';
                remarkInput.className = 'route-remark';
                remarkInput.placeholder = 'å‚™è€ƒ';
                remarkInput.value = route.remark || '';
                remarkInput.addEventListener('input', (e) => {
                    route.remark = e.target.value;
                    saveSchedule();
                });
                row.appendChild(remarkInput);

                container.appendChild(row);
            });

            // General Remarks
            const genRemarkInput = document.getElementById('generalRemarks');
            genRemarkInput.value = dayData.generalRemarks || '';
            genRemarkInput.oninput = (e) => {
                dayData.generalRemarks = e.target.value;
                saveSchedule();
            };

            updateOutputText();
        }

        function setupEventListeners() {
            // Clinic Tabs
            const clinicTabs = document.querySelectorAll('.clinic-tab');
            clinicTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    clinicTabs.forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentClinic = e.target.getAttribute('data-clinic');
                    renderRoutes();
                });
            });

            // Modal Close
            document.getElementById('closeSelectionModal').addEventListener('click', closeSelectionModal);
            document.getElementById('selectionModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('selectionModal')) closeSelectionModal();
            });

            // Actions
            document.getElementById('btnCopy').addEventListener('click', copyToClipboard);
            document.getElementById('btnGenerateAll').addEventListener('click', () => {
                updateOutputText(true);
            });

            // Exporters
            document.getElementById('btnExport').addEventListener('click', exportMasterData);
            document.getElementById('btnImport').addEventListener('click', () => {
                // simple import via prompt for now (will build modal later)
                const jsonStr = prompt('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š');
                if (jsonStr) {
                    try {
                        const parsed = JSON.parse(jsonStr);
                        if (parsed.driver && parsed.dr && parsed.cd && parsed.ns) {
                            masterData = parsed;
                            localStorage.setItem(STORAGE_KEY_MASTER, JSON.stringify(masterData));
                            alert('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                            renderRoutes();
                        } else {
                            alert('ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚');
                        }
                    } catch (e) {
                        alert('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                }
            });
        }

        // --- 6. Modal Selection Logic ---
        let currentEditingRouteIndex = -1;
        let currentEditingFieldType = '';

        function openSelectionModal(routeIndex, fieldType, fieldTitle) {
            currentEditingRouteIndex = routeIndex;
            currentEditingFieldType = fieldType;

            const modalTitle = document.getElementById('selectionModalTitle');
            modalTitle.textContent = `${fieldTitle}ã‚’é¸æŠ (${currentClinic})`;

            const grid = document.getElementById('selectionGrid');
            grid.innerHTML = '';

            // Map UI field type to Master data key
            let masterKey = fieldType;
            if (fieldType === 'dr_am' || fieldType === 'dr_pm') masterKey = 'dr';

            // Get Option List
            let options = [];
            if (masterKey === 'cd') {
                options = masterData.cd['å…±é€š'] || [];
            } else {
                options = masterData[masterKey][currentClinic] || [];
            }

            const currentVal = scheduleData[currentDateStr][currentClinic].routes[routeIndex][fieldType];

            // Render Empty Option (Clear)
            const emptyBtn = document.createElement('div');
            emptyBtn.className = `select-card empty-card`;
            emptyBtn.textContent = 'ã‚¯ãƒªã‚¢ (é¸æŠè§£é™¤)';
            emptyBtn.addEventListener('click', () => selectOption(''));
            grid.appendChild(emptyBtn);

            // Render Options
            options.forEach(opt => {
                if (!opt) return;
                const btn = document.createElement('div');
                btn.className = `select-card ${currentVal === opt ? 'selected' : ''}`;
                btn.textContent = opt;
                btn.addEventListener('click', () => selectOption(opt));
                grid.appendChild(btn);
            });

            document.getElementById('selectionModal').classList.add('active');
        }

        function selectOption(val) {
            if (currentEditingRouteIndex !== -1 && currentEditingFieldType) {
                scheduleData[currentDateStr][currentClinic].routes[currentEditingRouteIndex][currentEditingFieldType] = val;
                saveSchedule();
                renderRoutes(); // Re-render logic to update text
            }
            closeSelectionModal();
        }

        function closeSelectionModal() {
            document.getElementById('selectionModal').classList.remove('active');
            currentEditingRouteIndex = -1;
            currentEditingFieldType = '';
        }

        // --- 7. Output Text Generation ---
        function generateTextForDay(dateKey, clinic) {
            const data = scheduleData[dateKey]?.[clinic];
            if (!data) return '';

            const activeRoutes = data.routes.filter(r => r.driver || r.dr_am || r.cd || r.ns);
            if (activeRoutes.length === 0) return '';

            const dateDisplay = datesArray.find(d => d.dateKey === dateKey)?.displayStr || dateKey;

            let output = `${dateDisplay}\n`;

            activeRoutes.forEach((r, idx) => {
                // If the entire row is empty except for remark, maybe skip or show appropriately
                if (!r.driver && !r.dr_am && !r.cd && !r.ns) return;

                const driverStr = r.driver ? `${r.driver}Driverï¼š` : 'Driveræœªå®šï¼š';

                // Combine details
                let cdStr = r.cd ? `ã€${r.cd}CD` : '';
                let nsStr = r.ns ? `ã€${r.ns}NS` : '';
                let remarkStr = r.remark ? r.remark : '';

                // Logic for AM/PM split
                if (r.dr_pm && r.dr_pm !== r.dr_am) {
                    // Split pattern
                    const amStr = r.dr_am ? `AM${r.dr_am}Dr${cdStr}${nsStr}` : `AM(Dræœªå®š)${cdStr}${nsStr}`;
                    const pmStr = `PM${r.dr_pm}Dr${cdStr}${nsStr}${remarkStr}`;
                    output += `${driverStr}${amStr}/${pmStr}\n`;
                } else {
                    // Normal pattern
                    const drStr = r.dr_am ? `${r.dr_am}Dr` : '';
                    output += `${driverStr}${drStr}${cdStr}${nsStr}${remarkStr}\n`;
                }
            });

            if (data.generalRemarks) {
                output += `${data.generalRemarks}\n`;
            } else {
                output += `ä»¥ä¸Šã€ã‚ˆã‚ã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚\n`;
            }

            return output;
        }

        function updateOutputText(generateAll = false) {
            const textArea = document.getElementById('outputArea');
            if (generateAll) {
                let allOut = [];
                datesArray.forEach(d => {
                    const text = generateTextForDay(d.dateKey, currentClinic);
                    if (text.trim()) allOut.push(text.trim());
                });
                textArea.value = allOut.length > 0 ? allOut.join('\n\n') : 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            } else {
                const text = generateTextForDay(currentDateStr, currentClinic);
                textArea.value = text.trim();
            }
        }

        function copyToClipboard() {
            const textArea = document.getElementById('outputArea');
            if (!textArea.value || textArea.value === 'å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚') return;

            navigator.clipboard.writeText(textArea.value).then(() => {
                const btn = document.getElementById('btnCopy');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
                btn.style.background = '#43A047';
                setTimeout(() => {
                    btn.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    btn.style.background = 'var(--color-sub)';
                }, 2000);
            }).catch(err => {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('Copy failed', err);
            });
        }

        // --- 8. Export/Import Logic ---
        function exportMasterData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(masterData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "master_data.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Initialize when DOM loaded
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupMasterEditorEventListeners();
        });

        // --- 9. Master Editor Logic ---
        let editMasterType = 'driver'; // driver, dr, cd, ns
        let editMasterClinic = 'é«˜ç”°é¦¬å ´'; // é«˜ç”°é¦¬å ´, æ¸‹è°·, ä¸‰é·¹, å…±é€š

        function openMasterModal() {
            renderMasterEditor();
            document.getElementById('masterModal').classList.add('active');
        }

        function closeMasterModal() {
            document.getElementById('masterModal').classList.remove('active');
            renderRoutes(); // Re-render to reflect changes
        }

        function saveMaster() {
            localStorage.setItem(STORAGE_KEY_MASTER, JSON.stringify(masterData));
            renderMasterEditor();
        }

        function renderMasterEditor() {
            // Update Clinic Filter visibility based on role (CD is only "å…±é€š")
            const filterBtns = document.querySelectorAll('#masterClinicFilter .filter-btn');
            filterBtns.forEach(btn => {
                const c = btn.getAttribute('data-clinic');
                if (editMasterType === 'cd') {
                    btn.style.display = (c === 'å…±é€š') ? 'inline-block' : 'none';
                    if (c === 'å…±é€š') {
                        btn.classList.add('active');
                        editMasterClinic = 'å…±é€š';
                    } else {
                        btn.classList.remove('active');
                    }
                } else {
                    btn.style.display = (c === 'å…±é€š') ? 'none' : 'inline-block';
                    if (editMasterClinic === 'å…±é€š') editMasterClinic = 'é«˜ç”°é¦¬å ´'; // Reset if coming from CD
                    if (c === editMasterClinic) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });

            // Render Items
            const listEl = document.getElementById('masterItemList');
            listEl.innerHTML = '';

            const arr = masterData[editMasterType][editMasterClinic] || [];
            if (arr.length === 0) {
                listEl.innerHTML = '<span style="color:#999;font-size:0.9rem;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>';
            } else {
                arr.forEach((item, idx) => {
                    const d = document.createElement('div');
                    d.className = 'master-item';
                    d.innerHTML = `<span>${item}</span><span class="master-item-del" data-idx="${idx}">Ã—</span>`;
                    listEl.appendChild(d);
                });
            }

            // Bind delete events
            document.querySelectorAll('.master-item-del').forEach(el => {
                el.addEventListener('click', (e) => {
                    const idx = e.target.getAttribute('data-idx');
                    masterData[editMasterType][editMasterClinic].splice(idx, 1);
                    saveMaster();
                });
            });
        }

        function setupMasterEditorEventListeners() {
            document.getElementById('btnMaster').addEventListener('click', openMasterModal);
            document.getElementById('closeMasterModal').addEventListener('click', closeMasterModal);

            // Tabs
            const tabs = document.querySelectorAll('.master-tab');
            tabs.forEach(t => {
                t.addEventListener('click', (e) => {
                    tabs.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    editMasterType = e.target.getAttribute('data-type');
                    renderMasterEditor();
                });
            });

            // Clinic Filters
            const filters = document.querySelectorAll('.filter-btn');
            filters.forEach(f => {
                f.addEventListener('click', (e) => {
                    if (e.target.style.display === 'none') return;
                    filters.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    editMasterClinic = e.target.getAttribute('data-clinic');
                    renderMasterEditor();
                });
            });

            // Add new
            document.getElementById('btnAddNewItem').addEventListener('click', () => {
                const input = document.getElementById('newMasterItemName');
                const val = input.value.trim();
                if (val) {
                    if (!masterData[editMasterType][editMasterClinic]) {
                        masterData[editMasterType][editMasterClinic] = [];
                    }
                    if (!masterData[editMasterType][editMasterClinic].includes(val)) {
                        masterData[editMasterType][editMasterClinic].push(val);
                        saveMaster();
                        input.value = '';
                    } else {
                        alert('æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    }
                }
            });

            // Reset
            document.getElementById('btnResetMaster').addEventListener('click', () => {
                if (confirm('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®è¿½åŠ ãƒ»å‰Šé™¤å†…å®¹ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰')) {
                    masterData = JSON.parse(JSON.stringify(DEFAULT_MASTER));
                    saveMaster();
                }
            });
        }
    </script>
</body>

</html>